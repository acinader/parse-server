{"version":3,"sources":["../src/ParseServer.js"],"names":["logging","controllers","batch","require","bodyParser","express","middlewares","Parse","path","addParseCloud","ParseServer","constructor","options","injectDefaults","appId","masterKey","cloud","javascriptKey","serverURL","__indexBuildCompletionCallbackForTests","initialize","allControllers","getControllers","loggerController","databaseController","hooksController","config","Config","put","Object","assign","setLogger","dbInitPromise","performInitialization","load","process","env","TESTING","resolve","cwd","app","_app","handleShutdown","adapter","maxUploadSize","api","use","allowCrossDomain","FilesRouter","expressRouter","req","res","json","status","urlencoded","extended","PublicAPIRouter","limit","allowMethodOverride","handleParseHeaders","appRouter","promiseRouter","handleParseErrors","on","err","code","stderr","write","port","exit","verifyServerUrl","PARSE_SERVER_ENABLE_EXPERIMENTAL_DIRECT_ACCESS","CoreManager","setRESTController","routers","ClassesRouter","UsersRouter","SessionsRouter","RolesRouter","AnalyticsRouter","InstallationsRouter","FunctionsRouter","SchemasRouter","PushRouter","LogsRouter","IAPValidationRouter","FeaturesRouter","GlobalConfigRouter","PurgeRouter","HooksRouter","CloudCodeRouter","AudiencesRouter","AggregateRouter","routes","reduce","memo","router","concat","PromiseRouter","mountOnto","start","callback","middleware","mountPath","server","listen","host","startLiveQueryServer","liveQueryServerOptions","liveQueryServer","createLiveQueryServer","configureListeners","expressApp","parseServer","httpServer","createServer","ParseLiveQueryServer","request","replace","error","response","body","JSON","parse","e","statusCode","console","warn","ParseCloud","Cloud","global","keys","defaults","forEach","key","hasOwnProperty","userSensitiveFields","Array","from","Set","masterKeyIps","sockets","socket","socketId","remoteAddress","remotePort","destroyAliveConnections","destroy","stdout","close"],"mappings":"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","file":"ParseServer.js","sourcesContent":["// ParseServer - open-source compatible API Server for Parse apps\n\nvar batch = require('./batch'),\n  bodyParser = require('body-parser'),\n  express = require('express'),\n  middlewares = require('./middlewares'),\n  Parse = require('parse/node').Parse,\n  path = require('path');\n\nimport { ParseServerOptions,\n  LiveQueryServerOptions }      from './Options';\nimport defaults                 from './defaults';\nimport * as logging             from './logger';\nimport Config                   from './Config';\nimport PromiseRouter            from './PromiseRouter';\nimport requiredParameter        from './requiredParameter';\nimport { AnalyticsRouter }      from './Routers/AnalyticsRouter';\nimport { ClassesRouter }        from './Routers/ClassesRouter';\nimport { FeaturesRouter }       from './Routers/FeaturesRouter';\nimport { FilesRouter }          from './Routers/FilesRouter';\nimport { FunctionsRouter }      from './Routers/FunctionsRouter';\nimport { GlobalConfigRouter }   from './Routers/GlobalConfigRouter';\nimport { HooksRouter }          from './Routers/HooksRouter';\nimport { IAPValidationRouter }  from './Routers/IAPValidationRouter';\nimport { InstallationsRouter }  from './Routers/InstallationsRouter';\nimport { LogsRouter }           from './Routers/LogsRouter';\nimport { ParseLiveQueryServer } from './LiveQuery/ParseLiveQueryServer';\nimport { PublicAPIRouter }      from './Routers/PublicAPIRouter';\nimport { PushRouter }           from './Routers/PushRouter';\nimport { CloudCodeRouter }      from './Routers/CloudCodeRouter';\nimport { RolesRouter }          from './Routers/RolesRouter';\nimport { SchemasRouter }        from './Routers/SchemasRouter';\nimport { SessionsRouter }       from './Routers/SessionsRouter';\nimport { UsersRouter }          from './Routers/UsersRouter';\nimport { PurgeRouter }          from './Routers/PurgeRouter';\nimport { AudiencesRouter }      from './Routers/AudiencesRouter';\nimport { AggregateRouter }      from './Routers/AggregateRouter';\n\nimport { ParseServerRESTController } from './ParseServerRESTController';\nimport * as controllers from './Controllers';\n// Mutate the Parse object to add the Cloud Code handlers\naddParseCloud();\n\n// ParseServer works like a constructor of an express app.\n// The args that we understand are:\n// \"analyticsAdapter\": an adapter class for analytics\n// \"filesAdapter\": a class like GridStoreAdapter providing create, get,\n//                 and delete\n// \"loggerAdapter\": a class like WinstonLoggerAdapter providing info, error,\n//                 and query\n// \"jsonLogs\": log as structured JSON objects\n// \"databaseURI\": a uri like mongodb://localhost:27017/dbname to tell us\n//          what database this Parse API connects to.\n// \"cloud\": relative location to cloud code to require, or a function\n//          that is given an instance of Parse as a parameter.  Use this instance of Parse\n//          to register your cloud code hooks and functions.\n// \"appId\": the application id to host\n// \"masterKey\": the master key for requests to this app\n// \"collectionPrefix\": optional prefix for database collection names\n// \"fileKey\": optional key from Parse dashboard for supporting older files\n//            hosted by Parse\n// \"clientKey\": optional key from Parse dashboard\n// \"dotNetKey\": optional key from Parse dashboard\n// \"restAPIKey\": optional key from Parse dashboard\n// \"webhookKey\": optional key from Parse dashboard\n// \"javascriptKey\": optional key from Parse dashboard\n// \"push\": optional key from configure push\n// \"sessionLength\": optional length in seconds for how long Sessions should be valid for\n// \"maxLimit\": optional upper bound for what can be specified for the 'limit' parameter on queries\n\nclass ParseServer {\n\n  constructor(options: ParseServerOptions) {\n    injectDefaults(options);\n    const {\n      appId = requiredParameter('You must provide an appId!'),\n      masterKey = requiredParameter('You must provide a masterKey!'),\n      cloud,\n      javascriptKey,\n      serverURL = requiredParameter('You must provide a serverURL!'),\n      __indexBuildCompletionCallbackForTests = () => {},\n    } = options;\n    // Initialize the node client SDK automatically\n    Parse.initialize(appId, javascriptKey || 'unused', masterKey);\n    Parse.serverURL = serverURL;\n\n    const allControllers = controllers.getControllers(options);\n\n    const {\n      loggerController,\n      databaseController,\n      hooksController,\n    } = allControllers;\n    this.config = Config.put(Object.assign({}, options, allControllers));\n\n    logging.setLogger(loggerController);\n    const dbInitPromise = databaseController.performInitialization();\n    hooksController.load();\n\n    // Note: Tests will start to fail if any validation happens after this is called.\n    if (process.env.TESTING) {\n      __indexBuildCompletionCallbackForTests(dbInitPromise);\n    }\n\n    if (cloud) {\n      addParseCloud();\n      if (typeof cloud === 'function') {\n        cloud(Parse)\n      } else if (typeof cloud === 'string') {\n        require(path.resolve(process.cwd(), cloud));\n      } else {\n        throw \"argument 'cloud' must either be a string or a function\";\n      }\n    }\n  }\n\n  get app() {\n    if (!this._app) {\n      this._app = ParseServer.app(this.config);\n    }\n    return this._app;\n  }\n\n  handleShutdown() {\n    const { adapter } = this.config.databaseController;\n    if (adapter && typeof adapter.handleShutdown === 'function') {\n      adapter.handleShutdown();\n    }\n  }\n\n  static app({maxUploadSize = '20mb', appId}) {\n    // This app serves the Parse API directly.\n    // It's the equivalent of https://api.parse.com/1 in the hosted Parse API.\n    var api = express();\n    //api.use(\"/apps\", express.static(__dirname + \"/public\"));\n    // File handling needs to be before default middlewares are applied\n    api.use('/', middlewares.allowCrossDomain, new FilesRouter().expressRouter({\n      maxUploadSize: maxUploadSize\n    }));\n\n    api.use('/health', (function(req, res) {\n      res.json({\n        status: 'ok'\n      });\n    }));\n\n    api.use('/', bodyParser.urlencoded({extended: false}), new PublicAPIRouter().expressRouter());\n\n    api.use(bodyParser.json({ 'type': '*/*' , limit: maxUploadSize }));\n    api.use(middlewares.allowCrossDomain);\n    api.use(middlewares.allowMethodOverride);\n    api.use(middlewares.handleParseHeaders);\n\n    const appRouter = ParseServer.promiseRouter({ appId });\n    api.use(appRouter.expressRouter());\n\n    api.use(middlewares.handleParseErrors);\n\n    // run the following when not testing\n    if (!process.env.TESTING) {\n      //This causes tests to spew some useless warnings, so disable in test\n      /* istanbul ignore next */\n      process.on('uncaughtException', (err) => {\n        if (err.code === \"EADDRINUSE\") { // user-friendly message for this common error\n          process.stderr.write(`Unable to listen on port ${err.port}. The port is already in use.`);\n          process.exit(0);\n        } else {\n          throw err;\n        }\n      });\n      // verify the server url after a 'mount' event is received\n      /* istanbul ignore next */\n      api.on('mount', function() {\n        ParseServer.verifyServerUrl();\n      });\n    }\n    if (process.env.PARSE_SERVER_ENABLE_EXPERIMENTAL_DIRECT_ACCESS === '1') {\n      Parse.CoreManager.setRESTController(ParseServerRESTController(appId, appRouter));\n    }\n    return api;\n  }\n\n  static promiseRouter({appId}) {\n    const routers = [\n      new ClassesRouter(),\n      new UsersRouter(),\n      new SessionsRouter(),\n      new RolesRouter(),\n      new AnalyticsRouter(),\n      new InstallationsRouter(),\n      new FunctionsRouter(),\n      new SchemasRouter(),\n      new PushRouter(),\n      new LogsRouter(),\n      new IAPValidationRouter(),\n      new FeaturesRouter(),\n      new GlobalConfigRouter(),\n      new PurgeRouter(),\n      new HooksRouter(),\n      new CloudCodeRouter(),\n      new AudiencesRouter(),\n      new AggregateRouter()\n    ];\n\n    const routes = routers.reduce((memo, router) => {\n      return memo.concat(router.routes);\n    }, []);\n\n    const appRouter = new PromiseRouter(routes, appId);\n\n    batch.mountOnto(appRouter);\n    return appRouter;\n  }\n\n  start(options: ParseServerOptions, callback: ?()=>void) {\n    const app = express();\n    if (options.middleware) {\n      let middleware;\n      if (typeof options.middleware == 'string') {\n        middleware = require(path.resolve(process.cwd(), options.middleware));\n      } else {\n        middleware = options.middleware; // use as-is let express fail\n      }\n      app.use(middleware);\n    }\n\n    app.use(options.mountPath, this.app);\n    const server = app.listen(options.port, options.host, callback);\n    this.server = server;\n\n    if (options.startLiveQueryServer || options.liveQueryServerOptions) {\n      this.liveQueryServer = ParseServer.createLiveQueryServer(server, options.liveQueryServerOptions);\n    }\n    /* istanbul ignore next */\n    if (!process.env.TESTING) {\n      configureListeners(this);\n    }\n    this.expressApp = app;\n    return this;\n  }\n\n  static start(options: ParseServerOptions, callback: ?()=>void) {\n    const parseServer = new ParseServer(options);\n    return parseServer.start(options, callback);\n  }\n\n  static createLiveQueryServer(httpServer, config: LiveQueryServerOptions) {\n    if (!httpServer || (config && config.port)) {\n      var app = express();\n      httpServer = require('http').createServer(app);\n      httpServer.listen(config.port);\n    }\n    return new ParseLiveQueryServer(httpServer, config);\n  }\n\n  static verifyServerUrl(callback) {\n    // perform a health check on the serverURL value\n    if(Parse.serverURL) {\n      const request = require('request');\n      request(Parse.serverURL.replace(/\\/$/, \"\") + \"/health\", function (error, response, body) {\n        let json;\n        try {\n          json = JSON.parse(body);\n        } catch(e) {\n          json = null;\n        }\n        if (error || response.statusCode !== 200 || !json || json && json.status !== 'ok') {\n          /* eslint-disable no-console */\n          console.warn(`\\nWARNING, Unable to connect to '${Parse.serverURL}'.` +\n            ` Cloud code and push notifications may be unavailable!\\n`);\n          /* eslint-enable no-console */\n          if(callback) {\n            callback(false);\n          }\n        } else {\n          if(callback) {\n            callback(true);\n          }\n        }\n      });\n    }\n  }\n}\n\nfunction addParseCloud() {\n  const ParseCloud = require(\"./cloud-code/Parse.Cloud\");\n  Object.assign(Parse.Cloud, ParseCloud);\n  global.Parse = Parse;\n}\n\nfunction injectDefaults(options: ParseServerOptions) {\n  Object.keys(defaults).forEach((key) => {\n    if (!options.hasOwnProperty(key)) {\n      options[key] = defaults[key];\n    }\n  });\n\n  if (!options.hasOwnProperty('serverURL')) {\n    options.serverURL = `http://localhost:${options.port}${options.mountPath}`;\n  }\n\n  options.userSensitiveFields = Array.from(new Set(options.userSensitiveFields.concat(\n    defaults.userSensitiveFields,\n    options.userSensitiveFields\n  )));\n\n  options.masterKeyIps = Array.from(new Set(options.masterKeyIps.concat(\n    defaults.masterKeyIps,\n    options.masterKeyIps\n  )));\n}\n\n// Those can't be tested as it requires a subprocess\n/* istanbul ignore next */\nfunction configureListeners(parseServer) {\n  const server = parseServer.server;\n  const sockets = {};\n  /* Currently, express doesn't shut down immediately after receiving SIGINT/SIGTERM if it has client connections that haven't timed out. (This is a known issue with node - https://github.com/nodejs/node/issues/2642)\n    This function, along with `destroyAliveConnections()`, intend to fix this behavior such that parse server will close all open connections and initiate the shutdown process as soon as it receives a SIGINT/SIGTERM signal. */\n  server.on('connection', (socket) => {\n    const socketId = socket.remoteAddress + ':' + socket.remotePort;\n    sockets[socketId] = socket;\n    socket.on('close', () => {\n      delete sockets[socketId];\n    });\n  });\n\n  const destroyAliveConnections = function() {\n    for (const socketId in sockets) {\n      try {\n        sockets[socketId].destroy();\n      } catch (e) { /* */ }\n    }\n  }\n\n  const handleShutdown = function() {\n    process.stdout.write('Termination signal received. Shutting down.');\n    destroyAliveConnections();\n    server.close();\n    parseServer.handleShutdown();\n  };\n  process.on('SIGTERM', handleShutdown);\n  process.on('SIGINT', handleShutdown);\n}\n\nexport default ParseServer;\n"]}