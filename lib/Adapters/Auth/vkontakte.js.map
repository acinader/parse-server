{"version":3,"sources":["../../../src/Adapters/Auth/vkontakte.js"],"names":["https","require","Parse","logger","default","validateAuthData","authData","params","vkOAuth2Request","then","response","access_token","request","appSecret","user_id","id","Error","OBJECT_NOT_FOUND","error","Promise","resolve","appIds","length","validateAppId","host","path","reject","get","res","data","on","chunk","JSON","parse","e","module","exports"],"mappings":"AAAA;;AAEA;;AAEA,IAAIA,QAAQC,QAAQ,OAAR,CAAZ;AACA,IAAIC,QAAQD,QAAQ,YAAR,EAAsBC,KAAlC;AACA,IAAIC,SAASF,QAAQ,cAAR,EAAwBG,OAArC;;AAEA;AACA,SAASC,gBAAT,CAA0BC,QAA1B,EAAoCC,MAApC,EAA4C;AAC1C,SAAOC,gBAAgBD,MAAhB,EAAwBE,IAAxB,CAA6B,UAAUC,QAAV,EAAoB;AACtD,QAAIA,YAAYA,SAASC,YAAzB,EAAuC;AACrC,aAAOC,QAAQ,YAAR,EAAsB,oCAAoCN,SAASK,YAA7C,GAA4D,iBAA5D,GAAgFJ,OAAOM,SAAvF,GAAmG,gBAAnG,GAAsHH,SAASC,YAA/H,GAA8I,SAApK,EAA+KF,IAA/K,CAAoL,UAAUC,QAAV,EAAoB;AAC7M,YAAIA,YAAYA,SAASA,QAArB,IAAiCA,SAASA,QAAT,CAAkBI,OAAlB,IAA6BR,SAASS,EAA3E,EAA+E;AAC7E;AACD;AACD,cAAM,IAAIb,MAAMc,KAAV,CAAgBd,MAAMc,KAAN,CAAYC,gBAA5B,EAA8C,mCAA9C,CAAN;AACD,OALM,CAAP;AAMD;AACDd,WAAOe,KAAP,CAAa,SAAb,EAAwB,sCAAxB;AACA,UAAM,IAAIhB,MAAMc,KAAV,CAAgBd,MAAMc,KAAN,CAAYC,gBAA5B,EAA8C,sCAA9C,CAAN;AACD,GAXM,CAAP;AAYD;;AAED,SAAST,eAAT,CAAyBD,MAAzB,EAAiC;AAC/B,SAAO,IAAIY,OAAJ,CAAY,UAAUC,OAAV,EAAmB;AACpC,QAAI,CAACb,MAAD,IAAW,CAACA,OAAOc,MAAnB,IAA6B,CAACd,OAAOc,MAAP,CAAcC,MAA5C,IAAsD,CAACf,OAAOM,SAA9D,IAA2E,CAACN,OAAOM,SAAP,CAAiBS,MAAjG,EAAyG;AACvGnB,aAAOe,KAAP,CAAa,SAAb,EAAwB,yDAAxB;AACA,YAAM,IAAIhB,MAAMc,KAAV,CAAgBd,MAAMc,KAAN,CAAYC,gBAA5B,EAA8C,yDAA9C,CAAN;AACD;AACDG;AACD,GANM,EAMJX,IANI,CAMC,YAAY;AAClB,WAAOG,QAAQ,cAAR,EAAwB,4BAA4BL,OAAOc,MAAnC,GAA4C,iBAA5C,GAAgEd,OAAOM,SAAvE,GAAmF,uCAA3G,CAAP;AACD,GARM,CAAP;AASD;;AAED;AACA,SAASU,aAAT,GAAyB;AACvB,SAAOJ,QAAQC,OAAR,EAAP;AACD;;AAED;AACA,SAASR,OAAT,CAAiBY,IAAjB,EAAuBC,IAAvB,EAA6B;AAC3B,SAAO,IAAIN,OAAJ,CAAY,UAAUC,OAAV,EAAmBM,MAAnB,EAA2B;AAC5C1B,UAAM2B,GAAN,CAAU,aAAaH,IAAb,GAAoB,GAApB,GAA0BC,IAApC,EAA0C,UAAUG,GAAV,EAAe;AACvD,UAAIC,OAAO,EAAX;AACAD,UAAIE,EAAJ,CAAO,MAAP,EAAe,UAAUC,KAAV,EAAiB;AAC9BF,gBAAQE,KAAR;AACD,OAFD;AAGAH,UAAIE,EAAJ,CAAO,KAAP,EAAc,YAAY;AACxB,YAAI;AACFD,iBAAOG,KAAKC,KAAL,CAAWJ,IAAX,CAAP;AACD,SAFD,CAEE,OAAMK,CAAN,EAAS;AACT,iBAAOR,OAAOQ,CAAP,CAAP;AACD;AACDd,gBAAQS,IAAR;AACD,OAPD;AAQD,KAbD,EAaGC,EAbH,CAaM,OAbN,EAae,YAAY;AACzBJ,aAAO,+CAAP;AACD,KAfD;AAgBD,GAjBM,CAAP;AAkBD;;AAEDS,OAAOC,OAAP,GAAiB;AACfb,iBAAeA,aADA;AAEflB,oBAAkBA;AAFH,CAAjB","file":"vkontakte.js","sourcesContent":["'use strict';\n\n// Helper functions for accessing the vkontakte API.\n\nvar https = require('https');\nvar Parse = require('parse/node').Parse;\nvar logger = require('../../logger').default;\n\n// Returns a promise that fulfills iff this user id is valid.\nfunction validateAuthData(authData, params) {\n  return vkOAuth2Request(params).then(function (response) {\n    if (response && response.access_token) {\n      return request(\"api.vk.com\", \"method/secure.checkToken?token=\" + authData.access_token + \"&client_secret=\" + params.appSecret + \"&access_token=\" + response.access_token + \"&v=5.59\").then(function (response) {\n        if (response && response.response && response.response.user_id == authData.id) {\n          return;\n        }\n        throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, 'Vk auth is invalid for this user.');\n      });\n    }\n    logger.error('Vk Auth', 'Vk appIds or appSecret is incorrect.');\n    throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, 'Vk appIds or appSecret is incorrect.');\n  });\n}\n\nfunction vkOAuth2Request(params) {\n  return new Promise(function (resolve) {\n    if (!params || !params.appIds || !params.appIds.length || !params.appSecret || !params.appSecret.length) {\n      logger.error('Vk Auth', 'Vk auth is not configured. Missing appIds or appSecret.');\n      throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, 'Vk auth is not configured. Missing appIds or appSecret.');\n    }\n    resolve();\n  }).then(function () {\n    return request(\"oauth.vk.com\", \"access_token?client_id=\" + params.appIds + \"&client_secret=\" + params.appSecret + \"&v=5.59&grant_type=client_credentials\");\n  });\n}\n\n// Returns a promise that fulfills iff this app id is valid.\nfunction validateAppId() {\n  return Promise.resolve();\n}\n\n// A promisey wrapper for api requests\nfunction request(host, path) {\n  return new Promise(function (resolve, reject) {\n    https.get(\"https://\" + host + \"/\" + path, function (res) {\n      var data = '';\n      res.on('data', function (chunk) {\n        data += chunk;\n      });\n      res.on('end', function () {\n        try {\n          data = JSON.parse(data);\n        } catch(e) {\n          return reject(e);\n        }\n        resolve(data);\n      });\n    }).on('error', function () {\n      reject('Failed to validate this access token with Vk.');\n    });\n  });\n}\n\nmodule.exports = {\n  validateAppId: validateAppId,\n  validateAuthData: validateAuthData\n};\n"]}