{"version":3,"sources":["../../../src/Adapters/Auth/spotify.js"],"names":["https","require","Parse","validateAuthData","authData","request","access_token","then","data","id","Error","OBJECT_NOT_FOUND","validateAppId","appIds","length","indexOf","path","Promise","resolve","reject","get","host","headers","res","on","chunk","JSON","parse","e","module","exports"],"mappings":";;AAAA;AACA,IAAIA,QAAQC,QAAQ,OAAR,CAAZ;AACA,IAAIC,QAAQD,QAAQ,YAAR,EAAsBC,KAAlC;;AAEA;AACA,SAASC,gBAAT,CAA0BC,QAA1B,EAAoC;AAClC,SAAOC,QAAQ,IAAR,EAAcD,SAASE,YAAvB,EACJC,IADI,CACEC,IAAD,IAAU;AACd,QAAIA,QAAQA,KAAKC,EAAL,IAAWL,SAASK,EAAhC,EAAoC;AAClC;AACD;AACD,UAAM,IAAIP,MAAMQ,KAAV,CACJR,MAAMQ,KAAN,CAAYC,gBADR,EAEJ,wCAFI,CAAN;AAGD,GARI,CAAP;AASD;;AAED;AACA,SAASC,aAAT,CAAuBC,MAAvB,EAA+BT,QAA/B,EAAyC;AACvC,MAAIE,eAAeF,SAASE,YAA5B;AACA,MAAI,CAACO,OAAOC,MAAZ,EAAoB;AAClB,UAAM,IAAIZ,MAAMQ,KAAV,CACJR,MAAMQ,KAAN,CAAYC,gBADR,EAEJ,iCAFI,CAAN;AAGD;AACD,SAAON,QAAQ,IAAR,EAAcC,YAAd,EACJC,IADI,CACEC,IAAD,IAAU;AACd,QAAIA,QAAQK,OAAOE,OAAP,CAAeP,KAAKC,EAApB,KAA2B,CAAC,CAAxC,EAA2C;AACzC;AACD;AACD,UAAM,IAAIP,MAAMQ,KAAV,CACJR,MAAMQ,KAAN,CAAYC,gBADR,EAEJ,wCAFI,CAAN;AAGD,GARI,CAAP;AASD;;AAED;AACA,SAASN,OAAT,CAAiBW,IAAjB,EAAuBV,YAAvB,EAAqC;AACnC,SAAO,IAAIW,OAAJ,CAAY,UAASC,OAAT,EAAkBC,MAAlB,EAA0B;AAC3CnB,UAAMoB,GAAN,CAAU;AACRC,YAAM,iBADE;AAERL,YAAM,SAASA,IAFP;AAGRM,eAAS;AACP,yBAAiB,YAAYhB;AADtB;AAHD,KAAV,EAMG,UAASiB,GAAT,EAAc;AACf,UAAIf,OAAO,EAAX;AACAe,UAAIC,EAAJ,CAAO,MAAP,EAAe,UAASC,KAAT,EAAgB;AAC7BjB,gBAAQiB,KAAR;AACD,OAFD;AAGAF,UAAIC,EAAJ,CAAO,KAAP,EAAc,YAAW;AACvB,YAAI;AACFhB,iBAAOkB,KAAKC,KAAL,CAAWnB,IAAX,CAAP;AACD,SAFD,CAEE,OAAMoB,CAAN,EAAS;AACT,iBAAOT,OAAOS,CAAP,CAAP;AACD;AACDV,gBAAQV,IAAR;AACD,OAPD;AAQD,KAnBD,EAmBGgB,EAnBH,CAmBM,OAnBN,EAmBe,YAAW;AACxBL,aAAO,oDAAP;AACD,KArBD;AAsBD,GAvBM,CAAP;AAwBD;;AAEDU,OAAOC,OAAP,GAAiB;AACflB,iBAAeA,aADA;AAEfT,oBAAkBA;AAFH,CAAjB","file":"spotify.js","sourcesContent":["// Helper functions for accessing the Spotify API.\nvar https = require('https');\nvar Parse = require('parse/node').Parse;\n\n// Returns a promise that fulfills iff this user id is valid.\nfunction validateAuthData(authData) {\n  return request('me', authData.access_token)\n    .then((data) => {\n      if (data && data.id == authData.id) {\n        return;\n      }\n      throw new Parse.Error(\n        Parse.Error.OBJECT_NOT_FOUND,\n        'Spotify auth is invalid for this user.');\n    });\n}\n\n// Returns a promise that fulfills if this app id is valid.\nfunction validateAppId(appIds, authData) {\n  var access_token = authData.access_token;\n  if (!appIds.length) {\n    throw new Parse.Error(\n      Parse.Error.OBJECT_NOT_FOUND,\n      'Spotify auth is not configured.');\n  }\n  return request('me', access_token)\n    .then((data) => {\n      if (data && appIds.indexOf(data.id) != -1) {\n        return;\n      }\n      throw new Parse.Error(\n        Parse.Error.OBJECT_NOT_FOUND,\n        'Spotify auth is invalid for this user.');\n    });\n}\n\n// A promisey wrapper for Spotify API requests.\nfunction request(path, access_token) {\n  return new Promise(function(resolve, reject) {\n    https.get({\n      host: 'api.spotify.com',\n      path: '/v1/' + path,\n      headers: {\n        'Authorization': 'Bearer ' + access_token\n      }\n    }, function(res) {\n      var data = '';\n      res.on('data', function(chunk) {\n        data += chunk;\n      });\n      res.on('end', function() {\n        try {\n          data = JSON.parse(data);\n        } catch(e) {\n          return reject(e);\n        }\n        resolve(data);\n      });\n    }).on('error', function() {\n      reject('Failed to validate this access token with Spotify.');\n    });\n  });\n}\n\nmodule.exports = {\n  validateAppId: validateAppId,\n  validateAuthData: validateAuthData\n};\n"]}